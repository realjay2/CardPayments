<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Payment Store with Receipts Lookup</title>
<style>
  body {
    background-color: #f6f9fc;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: #32325d;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 6px;
    box-shadow:
      0 0 20px rgba(50, 50, 93, 0.1),
      0 2px 5px rgba(50, 50, 93, 0.1),
      0 1px 1.5px rgba(0, 0, 0, 0.07);
    padding: 40px 30px;
  }
  h2, h3 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 24px;
  }
  label {
    display: block;
    font-size: 14px;
    color: #6b7c93;
    margin-bottom: 6px;
    margin-top: 15px;
  }
  input[type="text"],
  input[type="number"],
  textarea,
  select {
    width: 100%;
    padding: 12px 14px;
    font-size: 16px;
    border-radius: 4px;
    border: 1px solid #ccd0d5;
    background: #fafafa;
    color: #32325d;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    resize: none;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: #5469d4;
    background: white;
    box-shadow: 0 0 0 1px #5469d4;
  }
  button {
    margin-top: 25px;
    background-color: #5469d4;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    padding: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #4253b2;
  }
  .note {
    text-align: center;
    margin-top: 15px;
    font-size: 12px;
    color: #8898aa;
  }
  .link-box {
    padding: 10px;
    background: #f1f3f5;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 14px;
    word-break: break-all;
    cursor: pointer;
  }
  .hidden {
    display: none;
  }
  .input-with-icon {
    position: relative;
    width: 100%;
  }
  .card-icon {
    position: absolute;
    top: 50%;
    right: 14px;
    transform: translateY(-50%);
    height: 24px;
    width: 36px;
    pointer-events: none;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    filter: grayscale(100%);
    transition: filter 0.3s ease;
  }
  input[type="text"]:focus + .card-icon {
    filter: grayscale(0%);
  }
  .error {
    border-color: #fa755a !important;
    background: #fff5f5;
  }
  .error-message {
    color: #fa755a;
    font-size: 13px;
    position: absolute;
    top: 42px;
    right: 50px;
    font-weight: 600;
    white-space: nowrap;
    pointer-events: none;
  }

  /* Approved message styles */
  #approvedMessage {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745;
    color: white;
    padding: 16px 30px;
    border-radius: 30px;
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    box-shadow: 0 0 15px rgba(40, 167, 69, 0.7);
    opacity: 0;
    pointer-events: none;
    transition: bottom 0.5s ease, opacity 0.5s ease;
    z-index: 1000;
  }
  #approvedMessage.show {
    bottom: 30px;
    opacity: 1;
    pointer-events: auto;
  }
  #approvedMessage svg {
    margin-right: 12px;
    fill: white;
    width: 24px;
    height: 24px;
  }
  /* Receipts table styles */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.6rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    font-size: 14px;
    word-break: break-word;
  }
  th {
    background-color: #f4f6f9;
    font-weight: 600;
  }
  .nav-bar {
    text-align: center;
    margin-bottom: 20px;
  }
  .nav-bar button {
    margin: 0 10px;
    width: auto;
  }
</style>
</head>
<body>

<div class="nav-bar">
  <button onclick="showDashboard()">Dashboard</button>
  <button onclick="showReceipts()">Receipts</button>
</div>

<div id="dashboard" class="container">
  <h2>Payment Dashboard</h2>
  <label for="paymentPurpose">Set Payment Purpose</label>
  <input type="text" id="paymentPurpose" placeholder="E.g. Consulting Fee, Product X" required />
  <button onclick="generateLink()">Generate Payment Link</button>
  <div id="generatedLink" class="link-box hidden" title="Click to copy"></div>
  <p class="note">Click the generated link to copy it for sharing with customers.</p>
  <hr />
  <h3>Generated Links</h3>
  <ul id="savedLinks"></ul>
</div>

<div id="paymentFormPage" class="container hidden">
  <h2>Pay for: <span id="displayPurpose"></span></h2>
  <form id="paymentForm" onsubmit="return submitPayment(event)">
    <label for="amount">Payment Amount</label>
    <input
      type="number"
      id="amount"
      name="amount"
      min="0.01"
      step="0.01"
      placeholder="0.00"
      required
    />
    <label for="cardNumber">Card Number</label>
    <div class="input-with-icon" style="position:relative;">
      <input
        type="text"
        id="cardNumber"
        name="cardNumber"
        maxlength="19"
        placeholder="1234 5678 9012 3456"
        autocomplete="cc-number"
        required
        oninput="validateCardInput()"
        onblur="validateCardInput(true)"
      />
      <div id="cardIcon" class="card-icon"></div>
      <div id="cardError" class="error-message" style="display:none;">Unrecognized card type</div>
    </div>

    <label for="cvc">CVC</label>
    <input type="text" id="cvc" name="cvc" maxlength="4" placeholder="123" autocomplete="cc-csc" required />

    <label for="expDate">Expiration Date (MM/YY)</label>
    <input type="text" id="expDate" name="expDate" maxlength="5" placeholder="08/25" autocomplete="cc-exp" required />

    <label for="name">Name on Card</label>
    <input type="text" id="name" name="name" placeholder="Jane Doe" autocomplete="cc-name" required />

    <label for="address">Billing Address</label>
    <textarea id="address" name="address" placeholder="123 Main Street, Apt 4" required></textarea>

    <button type="submit">Pay</button>
  </form>
  <p class="note">Your information is securely processed and stored.</p>
</div>

<div id="receiptsPage" class="container hidden">
  <h2>Receipts</h2>
  <div id="receiptsContainer"></div>
</div>

<!-- Approved message popup -->
<div id="approvedMessage" role="alert" aria-live="assertive">
  <svg viewBox="0 0 24 24">
    <path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/>
  </svg>
  Payment Approved
</div>

<script>
  // Simple URL purpose encode/decode
  function encodePurpose(text) {
    return encodeURIComponent(text.trim().replace(/\s+/g, "-").toLowerCase());
  }
  function decodePurpose(text) {
    return decodeURIComponent(text).replace(/-/g, " ");
  }

  // Elements
  const dashboard = document.getElementById("dashboard");
  const paymentFormPage = document.getElementById("paymentFormPage");
  const receiptsPage = document.getElementById("receiptsPage");
  const generatedLinkBox = document.getElementById("generatedLink");
  const displayPurposeSpan = document.getElementById("displayPurpose");
  const paymentPurposeInput = document.getElementById("paymentPurpose");
  const savedLinksList = document.getElementById("savedLinks");
  const receiptsContainer = document.getElementById("receiptsContainer");

  // Storage keys
  const LINKS_STORAGE_KEY = "payment_links";

  // Save generated links persistently
  function saveLink(purpose, url) {
    let links = JSON.parse(localStorage.getItem(LINKS_STORAGE_KEY)) || [];
    if (!links.find(l => l.purpose === purpose && l.url === url)) {
      links.push({ purpose, url });
      localStorage.setItem(LINKS_STORAGE_KEY, JSON.stringify(links));
    }
    refreshSavedLinks();
  }

  function refreshSavedLinks() {
    let links = JSON.parse(localStorage.getItem(LINKS_STORAGE_KEY)) || [];
    if (!links.length) {
      savedLinksList.innerHTML = '<li>No saved payment links.</li>';
      return;
    }
    savedLinksList.innerHTML = links.map(l => 
      `<li><a href="${l.url}" target="_blank">${l.purpose}</a></li>`
    ).join("");
  }

  // Generate shareable payment link with purpose encoded in URL params
  function generateLink() {
    const purpose = paymentPurposeInput.value.trim();
    if (!purpose) {
      alert("Please enter a payment purpose.");
      return;
    }
    const encodedPurpose = encodePurpose(purpose);
    const baseUrl = window.location.origin + window.location.pathname;
    const paymentUrl = `${baseUrl}?purpose=${encodedPurpose}`;
    generatedLinkBox.textContent = paymentUrl;
    generatedLinkBox.classList.remove("hidden");
    generatedLinkBox.onclick = () => {
      navigator.clipboard.writeText(paymentUrl);
      alert("Payment link copied to clipboard!");
    };
    saveLink(purpose, paymentUrl);
  }

  // Navigation
  function showDashboard() {
    dashboard.classList.remove("hidden");
    paymentFormPage.classList.add("hidden");
    receiptsPage.classList.add("hidden");
    clearPaymentForm();
  }
  function showReceipts() {
    dashboard.classList.add("hidden");
    paymentFormPage.classList.add("hidden");
    receiptsPage.classList.remove("hidden");
    displayReceipts();
  }

  // Card detection and validation code
  const cardIcon = document.getElementById("cardIcon");
  const cardInput = document.getElementById("cardNumber");
  const cardError = document.getElementById("cardError");

  const cardTypes = {
    visa: /^4/,
    mastercard: /^(5[1-5]|2[2-7])/,
    amex: /^3[47]/,
    discover: /^(6011|65|64[4-9]|622)/,
    diners: /^3(0[0-5]|)/,
    jcb: /^35(2|[3-8])/,
  };

  function getCardType(number) {
    for (const [type, pattern] of Object.entries(cardTypes)) {
      if (pattern.test(number)) {
        return type;
      }
    }
    return null;
  }

  function updateCardIcon(type) {
    if (!type) {
      cardIcon.style.backgroundImage = "none";
      cardIcon.style.visibility = "hidden";
      return;
    }
    const logos = {
      visa: "https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png",
      mastercard: "https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png",
      amex: "https://upload.wikimedia.org/wikipedia/commons/3/30/American_Express_logo_%282018%29.svg",
      discover: "https://upload.wikimedia.org/wikipedia/commons/5/5a/Discover_Card_logo.svg",
      diners: "https://upload.wikimedia.org/wikipedia/commons/1/16/Diners_Club_Logo3.svg",
      jcb: "https://upload.wikimedia.org/wikipedia/commons/5/50/JCB_logo.svg",
    };
    cardIcon.style.backgroundImage = `url(${logos[type] || ""})`;
    cardIcon.style.visibility = "visible";
  }

  function validateCardInput(showOnBlur = false) {
    const number = cardInput.value.replace(/\s/g, "");
    const cardType = getCardType(number);
    updateCardIcon(cardType);

    if (!cardType && number.length > 0) {
      cardError.style.display = "block";
      cardInput.classList.add("error");
    } else {
      cardError.style.display = "none";
      cardInput.classList.remove("error");
    }

    if (!showOnBlur) {
      cardError.style.display = "none";
      cardInput.classList.remove("error");
    }
  }

  // Approved message popup logic
  const approvedMessage = document.getElementById("approvedMessage");
  function showApprovedMessage() {
    approvedMessage.classList.add("show");
    setTimeout(() => {
      approvedMessage.classList.remove("show");
    }, 3000);
  }

  // Clear form inputs & states
  function clearPaymentForm() {
    document.getElementById("paymentForm").reset();
    updateCardIcon(null);
    cardError.style.display = "none";
    cardInput.classList.remove("error");
  }

  // Save payment data by purpose in localStorage
  function savePaymentData(paymentData) {
    const storageKey = `payments_${encodePurpose(paymentData.purpose)}`;
    let existingPayments = JSON.parse(localStorage.getItem(storageKey)) || [];
    existingPayments.push(paymentData);
    localStorage.setItem(storageKey, JSON.stringify(existingPayments));
  }

  // Submit payment handler
  function submitPayment(event) {
    event.preventDefault();

    const number = cardInput.value.replace(/\s/g, "");
    const cardType = getCardType(number);
    if (!cardType) {
      alert("Please enter a valid or registered card type.");
      cardInput.focus();
      return false;
    }

    // Validate payment amount
    const amountInput = document.getElementById("amount");
    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert("Please enter a valid payment amount greater than 0.");
      amountInput.focus();
      return false;
    }

    const paymentPurpose = displayPurposeSpan.textContent || "unknown";

    const paymentData = {
      purpose: paymentPurpose,
      amount: amount.toFixed(2),
      cardNumber: cardInput.value.trim(),
      cvc: document.getElementById("cvc").value.trim(),
      expDate: document.getElementById("expDate").value.trim(),
      name: document.getElementById("name").value.trim(),
      address: document.getElementById("address").value.trim(),
      timestamp: new Date().toISOString(),
    };

    savePaymentData(paymentData);
    console.log("Saved Payment Data:", paymentData);

    clearPaymentForm();
    showApprovedMessage();

    return false;
  }

  // Display receipts grouped by purpose
  function displayReceipts() {
    let html = "";
    const links = JSON.parse(localStorage.getItem(LINKS_STORAGE_KEY)) || [];
    if (!links.length) {
      receiptsContainer.innerHTML = "<p>No payment links created yet.</p>";
      return;
    }

    links.forEach(({ purpose }) => {
      const storageKey = `payments_${encodePurpose(purpose)}`;
      const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
      if (payments.length === 0) return;

      html += `<h3>${purpose}</h3>`;
      html += `<table>
        <thead>
          <tr>
            <th>Amount</th>
            <th>Name</th>
            <th>Card</th>
            <th>Date/Time</th>
            <th>Address</th>
          </tr>
        </thead>
        <tbody>
          ${payments.map(p => `
            <tr>
              <td>$${p.amount}</td>
              <td>${p.name}</td>
              <td>**** **** **** ${p.cardNumber.slice(-4)}</td>
              <td>${new Date(p.timestamp).toLocaleString()}</td>
              <td>${p.address}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>`;
    });

    receiptsContainer.innerHTML = html || "<p>No payments recorded yet.</p>";
  }

  // Page load logic: show payment form if ?purpose= in URL, else dashboard
  window.addEventListener("DOMContentLoaded", () => {
    refreshSavedLinks();

    const urlParams = new URLSearchParams(window.location.search);
    const purpose = urlParams.get("purpose");
    if (purpose) {
      dashboard.classList.add("hidden");
      receiptsPage.classList.add("hidden");
      paymentFormPage.classList.remove("hidden");
      displayPurposeSpan.textContent = decodePurpose(purpose);
    } else {
      showDashboard();
    }
  });
</script>

<!-- Approved message popup -->
<div id="approvedMessage" role="alert" aria-live="assertive">
  <svg viewBox="0 0 24 24">
    <path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/>
  </svg>
  Payment Approved
</div>

</body>
</html>
